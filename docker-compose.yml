# ========================================
# Docker Compose para KanbanFlow Pro
# Deploy com Docker Compose + Traefik
# ========================================

version: '3.8'

services:
  # ==========================================
  # Frontend - React + Nginx
  # ==========================================
  frontend:
    image: jucivanfsantos/kanbanflow-frontend:latest
    container_name: kanbanflow-frontend
    restart: unless-stopped
    networks:
      - traefik_public
    labels:
      # Habilitar Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"

      # Configuração HTTP -> HTTPS redirect
      - "traefik.http.routers.kanbanflow-frontend.rule=Host(`kanbanflow.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-frontend.entrypoints=web"
      - "traefik.http.routers.kanbanflow-frontend.middlewares=redirect-to-https"

      # Configuração HTTPS
      - "traefik.http.routers.kanbanflow-frontend-secure.rule=Host(`kanbanflow.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-frontend-secure.entrypoints=websecure"
      - "traefik.http.routers.kanbanflow-frontend-secure.tls=true"
      - "traefik.http.routers.kanbanflow-frontend-secure.tls.certresolver=le"
      - "traefik.http.routers.kanbanflow-frontend-secure.service=kanbanflow-frontend"

      # Middleware de redirecionamento
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

      # Service e porta
      - "traefik.http.services.kanbanflow-frontend.loadbalancer.server.port=80"

  # ==========================================
  # Backend - Node.js + Express
  # ==========================================
  backend:
    image: jucivanfsantos/kanbanflow-backend:latest
    container_name: kanbanflow-backend
    restart: unless-stopped
    networks:
      - traefik_public
    volumes:
      - kanban_data:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3001
      - FRONTEND_URL=https://kanbanflow.visiochat.cloud
      - DATA_FILE_PATH=/app/data/tasks.json
    labels:
      # Habilitar Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"

      # Configuração HTTP -> HTTPS redirect
      - "traefik.http.routers.kanbanflow-backend.rule=Host(`kanbamapi.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-backend.entrypoints=web"
      - "traefik.http.routers.kanbanflow-backend.middlewares=redirect-to-https"

      # Configuração HTTPS
      - "traefik.http.routers.kanbanflow-backend-secure.rule=Host(`kanbamapi.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-backend-secure.entrypoints=websecure"
      - "traefik.http.routers.kanbanflow-backend-secure.tls=true"
      - "traefik.http.routers.kanbanflow-backend-secure.tls.certresolver=le"
      - "traefik.http.routers.kanbanflow-backend-secure.service=kanbanflow-backend"

      # Service e porta
      - "traefik.http.services.kanbanflow-backend.loadbalancer.server.port=3001"

# ==========================================
# Volumes
# ==========================================
volumes:
  kanban_data:
    driver: local

# ==========================================
# Redes
# ==========================================
networks:
  traefik_public:
    external: true
