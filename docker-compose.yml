# ========================================
# Docker Compose para KanbanFlow Pro
# Deploy com Docker Compose + Traefik
# ========================================

version: '3.8'

services:
  # ==========================================
  # Frontend - React + Nginx
  # ==========================================
  frontend:
    image: jucivanfsantos/kanbanflow-frontend:latest
    container_name: kanbanflow-frontend
    restart: unless-stopped
    networks:
      - traefik_public
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"
      - "traefik.http.routers.kanbanflow-frontend.rule=Host(`kanbanflow.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-frontend.entrypoints=websecure"
      - "traefik.http.routers.kanbanflow-frontend.tls.certresolver=le"
      - "traefik.http.services.kanbanflow-frontend.loadbalancer.server.port=80"
      - "traefik.http.services.kanbanflow-frontend.loadbalancer.passHostHeader=true"
    ports:
      - "8080:80"

  # ==========================================
  # Backend - Node.js + Express
  # ==========================================
  backend:
    image: jucivanfsantos/kanbanflow-backend:latest
    container_name: kanbanflow-backend
    restart: unless-stopped
    networks:
      - traefik_public
    volumes:
      - kanban_data:/app/data
    environment:
      - NODE_ENV=production
      - PORT=3001
      - FRONTEND_URL=https://kanbanflow.visiochat.cloud
      - DATA_FILE_PATH=/app/data/tasks.json
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik_public"
      - "traefik.http.routers.kanbanflow-backend.rule=Host(`kanbanapi.visiochat.cloud`)"
      - "traefik.http.routers.kanbanflow-backend.entrypoints=websecure"
      - "traefik.http.routers.kanbanflow-backend.tls.certresolver=le"
      - "traefik.http.services.kanbanflow-backend.loadbalancer.server.port=3001"
      - "traefik.http.services.kanbanflow-backend.loadbalancer.passHostHeader=true"
    ports:
      - "3001:3001"

# ==========================================
# Volumes
# ==========================================
volumes:
  kanban_data:
    driver: local

# ==========================================
# Redes
# ==========================================
networks:
  traefik_public:
    external: true
